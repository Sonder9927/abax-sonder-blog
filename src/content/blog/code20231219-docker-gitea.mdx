---
title: Docker build gitea & gitlab
date: "2023-12-19"
author: Sonder
authorGithub: sonder9927
authorImage: /images/uploads/zard-think.jpg
category: code
tags:
- docker
- project
- gitea
- git
description: Use docker to build gitea and gitlab.
---

# docker
å®‰è£… `docker` å’Œ `docker-compose`ï¼Œæœ€å¥½å‚ç…§å®˜ç½‘ [meet the prerequisites](https://docs.docker.com/engine/install/ubuntu/#prerequisites)ï¼Œå…ˆå¸è½½å¹²å‡€å†å®‰è£…ã€‚

docker å®‰è£…æˆåŠŸåï¼Œå¯èƒ½æ— æ³•å¯åŠ¨æœåŠ¡ï¼Œæ¨èä¸‹é¢å‡ ä¸ª debug çš„æŒ‡ä»¤ï¼Œæ‰¾åˆ°é”™è¯¯åé’ˆå¯¹æ€§åœ°ä¸Šç½‘æ‰¾è§£å†³æ–¹æ³•ã€‚

```sh

# `sudo` maybe needed
dockerd --debug
systemctl status docker
systemctl restart docker
journalctl -xe | grep docker
vi /etc/docker/daemon.json
systemctl daemon-reload
freee -h
df -h
```
ç¡®ä¿ docker æ˜¯ active(running) çš„ã€‚

<img src="/images/post-images/docker-status.png" alt="docker-status" width="72%" />

éƒ¨ç½²æ—¶æœ€å¥½ä¸è¦åœ¨æŒ‚è½½ç›˜ä¸Šå¯åŠ¨docker-composeï¼Œæˆ‘å½“æ—¶æŠ¥äº†`Error executing action `run` on resource 'ruby_block[directory resource: /data/GitLab]'`è¿™ç§é”™ï¼Œæ¢åˆ°ç³»ç»Ÿç›˜å¯åŠ¨docker-compose.ymlå°±æ²¡äº‹äº†ã€‚æ•°æ®æ–‡ä»¶å¯ä»¥æ”¾åœ¨æŒ‚è½½ç›˜ã€‚

---
æ¨èä½¿ç”¨ [dockge](https://github.com/louislam/dockge) ç®¡ç†dockerã€‚
å¯ä»¥çœ‹ä¸€ä¸‹ [Docker é¡¹ç›®åˆ†äº« - dockge- ç®¡ç† docker é¡¹ç›®ä»æœªå¦‚æ­¤ç®€å• å¯è§†åŒ–é¢æ¿ç®¡ç†é¡¹ç›® uptime kuma åŒä½œè€…](https://www.bilibili.com/video/BV1CC4y1F7zm/?spm_id_from=333.880.my_history.page.click&vd_source=c6295c977cbd3c06c9aa840e805a2f72)ã€‚


# gitlab

æµ…è¯•äº† gitlabï¼Œèƒ½å¤ŸæˆåŠŸæ­å»ºã€‚gitlabæ¯”è¾ƒåƒèµ„æºï¼Œæˆ‘çš„æœåŠ¡å™¨æ€§èƒ½ä¸é«˜ï¼Œæ²¡æœ‰ç»§ç»­ä½¿ç”¨ï¼Œè½¬ç”¨giteaäº†ã€‚

gitlab çš„ `docker-compose.yml`ï¼š
```yml

version: '3'

services:
  gitlab:
    image: 'gitlab/gitlab-ce'
    container_name: 'gitlab'
    restart: always
    hostname: '<host>'
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://<host>:8929'
        gitlab_rails['gitlab_shell_ssh_port'] = 2224
    ports:
      - '8929:8929'
      - '2224:22'
    volumes:
      - '/path/to/config:/etc/gitlab'
      - '/path/to/logs:/var/log/gitlab'
      - '/path/to/data:/var/opt/gitlab'
      - '/path/to/backups:/var/opt/gitlab/backups'
    cap_add:
      - SYS_ADMIN
      - DAC_READ_SEARCH
    shm_size: '256m'
```
# gitea

[Gitea](https://docs.gitea.com/zh-cn/) æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ DevOps å¹³å°è½¯ä»¶ã€‚ä»å¼€å‘è®¡åˆ’åˆ°äº§å“æˆå‹çš„æ•´ä¸ªè½¯ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œä»–éƒ½èƒ½å¤Ÿé«˜æ•ˆè€Œè½»æ¾çš„å¸®åŠ©å›¢é˜Ÿå’Œå¼€å‘è€…ã€‚åŒ…æ‹¬ Git æ‰˜ç®¡ã€ä»£ç å®¡æŸ¥ã€å›¢é˜Ÿåä½œã€è½¯ä»¶åŒ…æ³¨å†Œå’Œ CI/CDã€‚å®ƒä¸ GitHubã€Bitbucket å’Œ GitLab ç­‰æ¯”è¾ƒç±»ä¼¼ã€‚ Gitea æœ€åˆæ˜¯ä»Â [Gogs](http://gogs.io/)Â åˆ†æ”¯è€Œæ¥ï¼Œå‡ ä¹æ‰€æœ‰ä»£ç éƒ½å·²æ›´æ”¹ã€‚
## é¢„å…ˆå‡†å¤‡
å‚è€ƒ[å°å°æ ‘è“æ´¾å¹²å¤§äº‹ - è‡ªéƒ¨ç½² Git åº“ï¼ˆä¸€ï¼‰](https://zhuanlan.zhihu.com/p/488776808)è¿™ç¯‡æ–‡ç« ã€‚

å…ˆåˆ›å»ºå®¿ä¸»æ“ä½œç³»ç»Ÿä¸Šçš„ä¸€ä¸ªæ–°ç”¨æˆ· git æ¥è¿è¡Œ Gitea çš„æ•´ä¸ª Docker é•œåƒç¨‹åºã€‚

```sh

sudo adduser git
#Adding user `git' ...
#Adding new group `git' (1003) ...
#Adding new user `git' (1002) with group `git' ...
```
è®°ä½ä¸Šé¢è‡ªåŠ¨åˆ›å»ºçš„ user å’Œ group çš„ idï¼Œ1002 å’Œ 1003ã€‚

æ·»åŠ åˆ°dockerç»„ï¼Œä¸ç„¶æŠ¥é”™ï¼š

`permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get "http://%2Fvar%2Frun%2Fdocker.sock/v1.44/containers/json?all=1&filters=%7B%22label%22%3A%7B%22com.docker.compose.config-hash%22%3Atrue%2C%22com.docker.compose.project%3Dgitea%22%3Atrue%7D%7D": dial unix /var/run/docker.sock: connect: permission denied`

```sh

sudo usermod -aG docker git
sudo usermod -aG docker $USER
```
åº”è¯¥æ˜¯æ·»åŠ `git`æ¥ç€ï¼Œè®°ä¸æ¸…äº†ï¼Œéƒ½æ·»åŠ ä¹Ÿè¡Œã€‚

## éƒ¨ç½²
gitea çš„ `docker-compose.yml`ï¼š

```yml

version: '3'

networks:
  gitea:
    external: false

services:
  server:
    image: gitea/gitea:latest
    container_name: gitea
    environment:
      - USER_UID=1002
      - USER_GID=1003
      - GITEA__database__DB__TYPE=mysql
      - GITEA__database__HOST=db:3306
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea
      - GITEA__database__NAME=gitea
    restart: always
    networks:
        - gitea
    ports:
      - '3000:3000'
      - '2222:22'
    volumes:
      - /home/git/.ssh:/data/git/.ssh
      - ./gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - db

  db:
    image: mariadb:10
    container_name: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=maria
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea
      - MYSQL_DATABASE=gitea
      - MYSQL_LOG_CONSOLE=true
    ports:
      - 3307:3306
    networks:
      - gitea
    volumes:
      - ./maria/data:/var/lib/mysql
      - ./maria/conf:/etc/mysql/conf.d
```
è¿è¡Œ`docker-compose up -d`ï¼Œåœ¨æµè§ˆå™¨æ‰“å¼€`http://<host>:3000`ï¼Œå°±èƒ½æ‰“å¼€ gitea åˆå§‹åŒ–ç•Œé¢ï¼Œæ•°æ®åº“ç±»å‹é€‰æ‹© mysqlï¼Œç¬¬ä¸€ä¸ªæ³¨å†Œçš„ç”¨æˆ·å°†æˆä¸ºç®¡ç†å‘˜ã€‚

æ•°æ®åº“ä½¿ç”¨ `<host>` å’Œç«¯å£å· `3307`ï¼Œç”¨æˆ·ã€å¯†ç å’Œæ•°æ®åº“åœ¨ yml æ–‡ä»¶ä¸­é…ç½®äº†ï¼Œè¿æ¥æ•°æ®åº“åå¯ä»¥æ–°å¢ç”¨æˆ·å’Œæ•°æ®åº“ã€‚
## ä¿®æ”¹é…ç½®
ä¿®æ”¹ `gitea-data/gitea/conf/app.ini` æ–‡ä»¶ï¼Œå¦‚æ³¨å†Œå’Œæƒé™ç­‰é»˜è®¤è®¾ç½®ã€‚
## ç«¯å£

**é—®é¢˜**ï¼šhttp å’Œ ssh çš„ç«¯å£æš´éœ²ä¸å¤Ÿä¼˜é›…ï¼Œè€Œä¸”ä»“åº“çš„ ssh é“¾æ¥æ˜¾ç¤ºæ˜¯æ²¡æœ‰ç«¯å£çš„ï¼Œå¤åˆ¶é“¾æ¥åè¿˜å¾—è‡ªå·±åŠ ä¸Šç«¯å£å·ã€‚

**è§£å†³**ï¼š
1. ssh ç«¯å£é—®é¢˜

    ä½¿ç”¨ Gitea å®˜ç½‘çš„Â [SSHing Shim æ–¹å¼](https://docs.gitea.io/en-us/install-with-docker/#sshing-shim-with-authorized_keys)ã€‚åœ¨å®¿ä¸»æœºä¸Šä¾æ¬¡æ‰§è¡Œï¼š

    ```sh

    sudo -u git ssh-keygen -t rsa -b 4096 -C "Gitea Host Key"
    sudo -u git cat /home/git/.ssh/id_rsa.pub | sudo -u git tee -a /home/git/.ssh/authorized_keys
    sudo -u git chmod 600 /home/git/.ssh/authorized_keys
    cat <<"EOF" | sudo tee /usr/local/bin/gitea
    #!/bin/sh
    ssh -p 2222 -o StrictHostKeyChecking=no git@127.0.0.1         
    "SSH_ORIGINAL_COMMAND=\"$SSH_ORIGINAL_COMMAND\" $0 $@"
    EOF
    sudo chmod +x /usr/local/bin/gitea
    ```

    é…ç½®å®Œæˆåï¼Œ é‡æ–°å¯åŠ¨ Docker å®¹å™¨ï¼š`docker-compose up --force-recreate --build -d` å³å®Œæˆã€‚

2. http ç«¯å£é—®é¢˜
    
    å®˜æ–¹æ˜¯ç”¨ nginx åšçš„[åå‘ä»£ç†](https://docs.gitea.com/zh-cn/administration/reverse-proxies#%E4%BD%BF%E7%94%A8-nginx-%E4%BD%9C%E4%B8%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1)ï¼Œå› ä¸ºæˆ‘è¿˜éœ€è¦éƒ¨ç½²ä¸€ä¸ªé™æ€ç½‘é¡µï¼Œæ‰€ä»¥æ–°å¢äº†äº›å†…å®¹ã€‚


    åœ¨ yml æ–‡ä»¶ä¸­æ·»åŠ  nginx å®¹å™¨ï¼š

    ```yml

    nginx:
    image: nginx:latest
    container_name: nginx
    ports:
        - "80:80"
        - "443:443"
    volumes:
        - ./nginx/www:/usr/share/nginx/html
        - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
        - ./nginx/servers:/etc/nginx/servers:ro
    networks:
        - gitea
    depends_on:
        - server
    ```

    nginx çš„é…ç½®æ–‡ä»¶ `nginx/nginx.conf`ï¼š

    ```conf

    worker_processes 2;

    events {
    worker_connections 1024;
    }

    http {
    include mime.types;
    default_type application/octet-stream;

    sendfile on;
    keepalive_timeout 65;

    server {
        listen 80;
        server_name <host>;
        access_log host.access.log;

        location / {
        proxy_pass http://server:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
        location /<sub_site_name> {
        alias /usr/share/nginx/html;
        index index.html index.htm;
        }

        error_page 500 502 503 504 /50x.html;
        location = /50.html {
        root /usr/share/nginx/html;
        }
    }
    # include servers/*.conf;
    }
    ```

æµè§ˆå™¨æ‰“å¼€`http://<host>`å°±èƒ½æ‰“å¼€ giteaï¼ŒåŒ…æ‹¬ http ä¼ è¾“éƒ½ä¸ç”¨åŠ ç«¯å£å·äº†ã€‚æ­¤æ—¶ gitea çš„ä»“åº“ http é“¾æ¥è¿˜æ˜¯æœ‰ç«¯å£å·çš„ï¼Œä¿®æ”¹ `gitea-data/gitea/conf/app.ini` æ–‡ä»¶å°±è¡Œã€‚

**è¯´æ˜**ï¼šåªæ˜¯ä»£ç†äº†ç«¯å£å·ï¼Œæ²¡æœ‰ç¦æ­¢ç«¯å£è®¿é—®ï¼Œæ‰€ä»¥ `http://<host>:3000` ä¹Ÿèƒ½è®¿é—®ã€‚

æµè§ˆå™¨æ‰“å¼€`http://<host>/<sub_site_name>` å°±èƒ½æ‰“å¼€æˆ‘æ„å»ºåœ¨ `nginx/www` é‡Œçš„ç½‘é¡µäº†ã€‚é…åˆ [è‡ªå®šä¹‰ Gitea é¡µé¢](https://docs.gitea.com/zh-cn/administration/customizing-gitea#%E8%87%AA%E5%AE%9A%E4%B9%89-gitea-%E9%A1%B5%E9%9D%A2)ï¼Œå†™ä¸€ä¸ª `gitea-data/gitea/templates/custom/extra_links.tmpl` æ–‡ä»¶å°±èƒ½åœ¨å¯¼èˆªæ æ–°å¢é“¾æ¥äº†ã€‚å…¶å†…å®¹æ˜¯

```html

<a class="item" href="{{AppSubUrl}}/<sub_site_name>">site name</a>
```

## smtp é‚®ä»¶æœåŠ¡
[å®˜æ–¹ smtp è¯´æ˜](https://docs.gitea.com/zh-cn/administration/email-setup#%E4%BD%BF%E7%94%A8-smtp)

```ini

[mailer]
ENABLED        = true
FROM           = <email>
PROTOCOL    = smtps
SMTP_ADDR      = <smtp_address>
SMTP_PORT      = <smtp_port>
USER           = <email>
PASSWD         = `<passwd>`
```
`<email>`å°±æ˜¯ç”¨æ¥å‘é‚®ä»¶çš„é‚®ç®±åœ°å€ï¼Œå…³äº `<smtp_address>` å’Œ `<smtp_port>`ï¼Œéœ€è¦ç»™é‚®ç®±æ‰“å¼€ smtp æœåŠ¡ï¼Œå¯ä»¥çœ‹ä¸€ä¸‹[QQ é‚®ç®± ç½‘æ˜“é‚®ç®±åŠä¼ä¸šé‚®ç®±å¼€é€š SMTP/POP3 åŠè®¾ç½®æˆæƒç ï¼ˆå®¢æˆ·ç«¯ä¸“ç”¨å¯†ç ï¼‰çš„æ–¹æ³•å¤§å…¨](https://zhuanlan.zhihu.com/p/551399559?utm_id=0&wd=&eqid=bb018c6f000023ba0000000464765a52)
å¯†ç å¯ä»¥ä½¿ç”¨çœŸå®é‚®ç®±å¯†ç ï¼ˆä¸æ¨èï¼‰ï¼Œä¹Ÿå¯ä½¿ç”¨å¼€å¯ smtp æœåŠ¡åç”Ÿæˆçš„æˆæƒç ï¼Œä¹Ÿå«ç¬¬ä¸‰æ–¹ç™»å½•å¯†ç ã€‚

è‡ªåŠ¨å‘çš„é‚®ä»¶æœ‰æ—¶å€™ä¼šè¢«å½“åšåƒåœ¾é‚®ä»¶æ‹’å‘ï¼ŒæŸ¥çœ‹ email é‚®ç®±ï¼Œæ‰‹åŠ¨æ¿€æ´»éªŒè¯ç å°±è¡Œã€‚æˆ–è€…æ¢ä¸€ä¸ªé‚®ç®±ï¼Œæˆ‘ç”¨ qq é‚®ç®±æ²¡é—®é¢˜ï¼Œå­¦æ ¡é‚®ç®±å°±è¢«æ‹’å‘äº†ã€‚

## actions

[å®˜æ–¹ actions è¯´æ˜](https://docs.gitea.com/zh-cn/usage/actions/quickstart)

1. è¿›å…¥ä»“åº“è®¾ç½®ï¼Œæ‰“å¼€ actionsã€‚

2. æ³¨å†Œ runnerã€‚

    åœ¨ gitea é‡Œè·å–æ³¨å†Œç”¨çš„ `token`ï¼Œåªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œå¹¶ä¸”ä¸èƒ½ç”¨äºæ³¨å†Œå¤šä¸ª Runnerã€‚ å¯ä»¥ä»ä»¥ä¸‹ä½ç½®è·å–ä¸åŒçº§åˆ«çš„ token, ä»è€Œåˆ›å»ºå‡ºç›¸åº”çº§åˆ«çš„ runnerï¼š

    - å®ä¾‹çº§åˆ«ï¼šç®¡ç†å‘˜è®¾ç½®é¡µé¢ï¼Œä¾‹å¦‚ \<your_gitea.com>/admin/actions/runnersã€‚
    - ç»„ç»‡çº§åˆ«ï¼šç»„ç»‡è®¾ç½®é¡µé¢ï¼Œä¾‹å¦‚ \<your_gitea.com>/\<org>/settings/actions/runnersã€‚
    - å­˜å‚¨åº“çº§åˆ«ï¼šå­˜å‚¨åº“è®¾ç½®é¡µé¢ï¼Œä¾‹å¦‚ \<your_gitea.com>/\<owner>/\<repo>/settings/actions/runnersã€‚

    [ä½¿ç”¨ Docker æ³¨å†Œ Runner](https://docs.gitea.com/zh-cn/usage/actions/act-runner#%E4%BD%BF%E7%94%A8docker%E6%B3%A8%E5%86%8Crunner)

    ```yml

    version: "3.8"
    services:
    runner:
        image: gitea/act_runner:nightly
        environment:
        CONFIG_FILE: /config.yaml
        GITEA_INSTANCE_URL: "${INSTANCE_URL}"
        GITEA_RUNNER_REGISTRATION_TOKEN: "${REGISTRATION_TOKEN}"
        GITEA_RUNNER_NAME: "${RUNNER_NAME}"
        GITEA_RUNNER_LABELS: "${RUNNER_LABELS}"
        volumes:
        - ./config.yaml:/config.yaml
        - ./data:/data
        - /var/run/docker.sock:/var/run/docker.sock
    ```
    åœ¨ gitea åå°æŸ¥çœ‹ runner æ˜¯å¦æ³¨å†ŒæˆåŠŸä»¥åŠçŠ¶æ€ï¼Œå¦‚æœæ˜¯ç¦»çº¿åœ¨å®¿ä¸»æœºæ‰§è¡Œ `docker restart runner`ï¼Œrunner æ˜¯å®¹å™¨åç§°ï¼Œæ‰§è¡Œ`docker ps`å¯ä»¥æŸ¥çœ‹å®¹å™¨è¿è¡ŒçŠ¶æ€ã€‚

3. ç¼–å†™ `.gitea/workflows/demo.yaml`ï¼Œæ–‡ä»¶åå¯ä»¥ä¸ä¸€æ ·ã€‚
    ```yaml

    name: Gitea Actions Demo
    run-name: ${{ gitea.actor }} is testing out Gitea Actions ğŸš€
    on: [push]

    jobs:
    Explore-Gitea-Actions:
        runs-on: ubuntu-latest
        steps:
        - run: echo "ğŸ‰ The job was automatically triggered by a ${{ gitea.event_name }} event."
        - run: echo "ğŸ§ This job is now running on a ${{ runner.os }} server hosted by Gitea!"
        - run: echo "ğŸ” The name of your branch is ${{ gitea.ref }} and your repository is ${{ gitea.repository }}."
        - name: Check out repository code
            uses: actions/checkout@v3
        - run: echo "ğŸ’¡ The ${{ gitea.repository }} repository has been cloned to the runner."
        - run: echo "ğŸ–¥ï¸ The workflow is now ready to test your code on the runner."
        - name: List files in the repository
            run: |
            ls ${{ gitea.workspace }}
        - run: echo "ğŸ This job's status is ${{ job.status }}."
    ```

4. æ¯æ¬¡ `git  push` åéƒ½ä¼šè‡ªåŠ¨æ‰§è¡Œã€‚

## æœ€ç»ˆçš„ yml æ–‡ä»¶

æ³¨æ„ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ä¸è¦å¸¦ä¸Š act_runnerï¼Œå› ä¸ºä»–éœ€è¦ gitea çš„ tokenã€‚

```yml

version: '3'

networks:
  gitea:
    external: false

services:
  server:
    image: gitea/gitea:latest
    container_name: gitea
    environment:
      - USER_UID=1002
      - USER_GID=1003
      - GITEA__database__DB__TYPE=mysql
      - GITEA__database__HOST=db:3306
      - GITEA__database__USER=gitea
      - GITEA__database__PASSWD=gitea
      - GITEA__database__NAME=gitea
    restart: always
    networks:
        - gitea
    ports:
      - '3000:3000'
      - '2222:22'
    volumes:
      - /home/git/.ssh:/data/git/.ssh
      - ./gitea-data:/data
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - db

  db:
    image: mariadb:10
    container_name: mariadb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=maria
      - MYSQL_USER=gitea
      - MYSQL_PASSWORD=gitea
      - MYSQL_DATABASE=gitea
      - MYSQL_LOG_CONSOLE=true
    ports:
      - 3307:3306
    networks:
      - gitea
    volumes:
      - ./maria/data:/var/lib/mysql
      - ./maria/conf:/etc/mysql/conf.d

  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/www:/usr/share/nginx/html
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/servers:/etc/nginx/servers:ro
    networks:
      - gitea
    depends_on:
      - server

  runner:
    image: gitea/act_runner:nightly
    container_name: gitea_runner
    environment:
      CONFIG_FILE: /config.yaml
      GITEA_INSTANCE_URL: "http://<host>:3000"
      GITEA_RUNNER_REGISTRATION_TOKEN: "<token>"
      GITEA_RUNNER_NAME: "mkdocs"
    volumes:
      - ./runner-data/config.yaml:/config.yaml
      - ./runner-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
```
